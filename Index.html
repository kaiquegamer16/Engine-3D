<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Monkey</title>
    <!-- Dependências Externas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://unpkg.com/cannon@0.6.2/build/cannon.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // ... (código Firebase igual ao anterior) ...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAKfOel4jvdoi01LTSpf2HW5HYEhwQPq7k",
            authDomain: "engine-e21ab.firebaseapp.com",
            databaseURL: "https://engine-e21ab-default-rtdb.firebaseio.com",
            projectId: "engine-e21ab",
            storageBucket: "engine-e21ab.firebasestorage.app",
            messagingSenderId: "458424557162",
            appId: "1:458424557162:web:d7e3226d4475c4895c3413",
            measurementId: "G-QEEJE4Z7XH"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const database = getDatabase(app); 

        window.firebaseRefs = {
            getDatabase: getDatabase,
            ref: ref,
            set: set,
            get: get,
            child: child,
            onValue: onValue 
        };
        console.log("Firebase (Info): SDKs inicializados e database disponível via window.firebaseRefs.");
    </script>

    <script src="MotorJM.js"></script>

    <style>
        :root {
            --cor-fundo-principal: #222;
            --cor-painel: #333;
            --cor-borda: #444;
            --cor-texto: #eee;
            --cor-editor-console: #1a1a1a;
            --cor-botao-normal: #555;
            --cor-botao-hover: #777;
            --cor-botao-ativo: #007bff;
            --cor-info: #6bcf6b;
            --cor-erro: #ff6b6b;
            --cor-aviso: #ffd700;
            --altura-toolbar: 50px; /* Altura da barra de ferramentas principal */
            --altura-console-desktop: 200px;
            --altura-console-mobile: 150px;
            --padding-geral: 10px;
        }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Previne scroll no body */
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--cor-fundo-principal); 
            color: var(--cor-texto); 
            display: flex; 
            flex-direction: column; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #main-toolbar { 
            display: flex; align-items: center; background-color: var(--cor-painel); 
            padding: 8px var(--padding-geral); border-bottom: 1px solid var(--cor-borda); 
            gap: 10px; overflow-x: auto; white-space: nowrap; 
            flex-shrink: 0; height: var(--altura-toolbar); box-sizing: border-box;
            scrollbar-width: none; -ms-overflow-style: none; 
        }
        #main-toolbar::-webkit-scrollbar { display: none; }
        #main-toolbar .logo { font-weight: bold; font-size: 1.2em; margin-right: 15px; color: white; }
        #main-toolbar button { background-color: var(--cor-botao-normal); color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 0.9em; transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 5px; flex-shrink: 0; }
        #main-toolbar button:hover { background-color: var(--cor-botao-hover); }
        #main-toolbar button.ativo { background-color: var(--cor-botao-ativo); }
        #main-toolbar button.ativo:hover { background-color: #0056b3; }
        
        #main-content-container { 
            display: flex; 
            flex-direction: column; /* Empilha verticalmente em mobile */
            flex-grow: 1; 
            overflow: hidden; 
            padding: var(--padding-geral); 
            box-sizing: border-box; 
            gap: var(--padding-geral);
        }
        #cena-3d { 
            flex-grow: 1; /* Ocupa o espaço disponível */
            background-color: #111; 
            border: 1px solid var(--cor-borda); 
            border-radius: 4px; 
            overflow: hidden; 
            position: relative; 
            min-height: 200px; /* Altura mínima para mobile */
        }
        #cena-3d canvas { display: block; width: 100%; height: 100%; }
        
        #left-panel { 
            background-color: var(--cor-painel); border: 1px solid var(--cor-borda); 
            border-radius: 4px; padding: var(--padding-geral); box-sizing: border-box; 
            display: none; /* Controlado por JS e media query */
            flex-direction: column; gap: 10px; 
            width: 200px; /* Largura para desktop */
            flex-shrink: 0;
            overflow-y: auto;
        }
        #right-panel-container { 
            background-color: var(--cor-painel); 
            border: 1px solid var(--cor-borda); 
            border-radius: 4px; 
            box-sizing: border-box; 
            display: none; /* Controlado por JS e media query */
            flex-direction: column; 
            width: 300px; 
            flex-shrink: 0;
            overflow: hidden; /* Importante para o conteúdo interno */
        }
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--cor-borda);
            flex-shrink: 0; /* Não encolhe */
        }
        .panel-tabs button {
            flex-grow: 1;
            background-color: var(--cor-botao-normal);
            color: white;
            border: none;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            border-radius: 0; 
        }
        .panel-tabs button:first-child { border-top-left-radius: 3px; }
        .panel-tabs button:last-child { border-top-right-radius: 3px; }
        .panel-tabs button:hover { background-color: var(--cor-botao-hover); }
        .panel-tabs button.ativo { background-color: var(--cor-botao-ativo); }

        #right-panel, #file-manager-panel { 
            padding: var(--padding-geral); 
            border: none; 
            border-radius: 0; 
            flex-grow: 1; 
            overflow-y: auto; 
            display: none; /* Controlado por JS */
        }
        #right-panel.visivel, #file-manager-panel.visivel {
            display: flex; /* Mostra a aba ativa */
            flex-direction: column; /* Garante que o conteúdo interno se empilhe */
        }

        #left-panel h4, #right-panel h4, #file-manager-panel h4 { margin-top: 0; margin-bottom: 10px; color: var(--cor-texto); border-bottom: 1px solid var(--cor-borda); padding-bottom: 5px; }
        
        #object-hierarchy { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #object-hierarchy li { padding: 3px 5px; cursor: pointer; border-radius: 3px; margin-bottom: 1px; display: flex; align-items: center; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #object-hierarchy li:hover { background-color: var(--cor-botao-hover); }
        #object-hierarchy li.selected { background-color: var(--cor-botao-ativo); font-weight: bold; }
        #object-hierarchy li .hierarchy-toggle { 
            width: 15px; height: 15px; margin-right: 3px; display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.7em; color: #ccc;
        }
        #object-hierarchy li .hierarchy-toggle.empty { visibility: hidden; }
        #object-hierarchy ul { list-style: none; padding-left: 15px; margin: 0; }
        #object-hierarchy li > i { margin-right: 5px; }


        #object-properties { flex-grow: 1; /* Para ocupar espaço no #right-panel */ }
        #object-properties label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: bold; }
        #object-properties input[type="text"], #object-properties input[type="number"], #object-properties input[type="color"], #object-properties select { width: calc(100% - 12px); padding: 8px; margin-bottom: 10px; border: 1px solid #555; background-color: var(--cor-borda); color: var(--cor-texto); border-radius: 4px; font-size: 0.9em; box-sizing: border-box; }
        #object-properties input[type="color"] { height: 38px; padding: 2px; }
        .prop-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .prop-row .prop-label { width: 20px; text-align: center; font-weight: bold; color: #ccc; flex-shrink: 0;}
        .prop-row input { margin-bottom: 0 !important; flex-grow: 1; }
        .texture-input-row { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        .texture-input-row input[type="text"] { flex-grow: 1; margin: 0; font-size: 0.8em; }
        .texture-input-row button { padding: 8px; font-size: 0.8em; flex-shrink: 0; background-color: var(--cor-botao-normal); border: none; color: white; border-radius: 4px; cursor: pointer;}
        .texture-input-row button:hover { background-color: var(--cor-botao-hover); }
        .property-group { border: 1px solid var(--cor-borda); border-radius: 5px; padding: 10px; margin-bottom: 10px; background-color: #2a2a2a; }
        .property-group h5 { margin-top: 0; margin-bottom: 10px; color: var(--cor-texto); font-size: 1em; }
        
        /* Código Editor, Console e Modais (sem grandes mudanças de layout aqui) */
        #codigo-editor-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80vw; height: 60vh; z-index: 1000; background-color: var(--cor-editor-console); border: 1px solid var(--cor-borda); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; flex-direction: column; overflow: hidden; }
        #codigo-editor-container.visivel { display: flex; }
        #codigo-editor { flex-grow: 1; width: 100%; height: 100%; font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace; font-size: 0.9em; }
        #codigo-editor-header { background-color: #2a2a2a; padding: 8px 10px; border-bottom: 1px solid var(--cor-borda); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
        #codigo-editor-header button { background-color: var(--cor-botao-normal); color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        #codigo-editor-header button:hover { background-color: var(--cor-botao-hover); }
        #bottom-panel { background-color: var(--cor-painel); border: 1px solid var(--cor-borda); border-radius: 4px; box-sizing: border-box; display: flex; flex-direction: column; flex-shrink: 0; margin: var(--padding-geral); margin-top: 0; height: var(--altura-console-mobile);}
        #bottom-panel.hidden { display: none; }
        #console-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 5px 10px; background-color: #2a2a2a; border-bottom: 1px solid var(--cor-borda); flex-shrink: 0; gap: 10px; }
        #console-header h3 { margin: 0; font-size: 1em; color: var(--cor-texto); flex-shrink: 0; }
        .console-controls { display: flex; flex-wrap: wrap; gap: 5px; }
        .console-controls button { background-color: var(--cor-botao-normal); color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .console-controls button.ativo { background-color: var(--cor-botao-ativo); }
        #btn-fechar-console { margin-left: auto; font-size: 1.2em; padding: 0 5px; }
        #console-output { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: var(--cor-editor-console); color: var(--cor-texto); font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace; font-size: 0.85em; margin: 0; white-space: pre-wrap; }
        #console-output span { display: block; margin-bottom: 2px; }
        #console-output .info { color: var(--cor-info); }
        #console-output .warning { color: var(--cor-aviso); }
        #console-output .error { color: var(--cor-erro); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.3s; }
        .modal-overlay.visivel { visibility: visible; opacity: 1; }
        .modal-conteudo { background-color: var(--cor-painel); padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative; }
        .modal-conteudo h3 { margin-top: 0; color: var(--cor-texto); border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-conteudo label { display: block; margin-bottom: 8px; color: var(--cor-texto); }
        .modal-conteudo input, .modal-conteudo select { width: calc(100% - 20px); padding: 8px; margin-top: 4px; border: 1px solid #555; background-color: var(--cor-borda); color: var(--cor-texto); border-radius: 4px; }
        .modal-botoes { margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-botoes button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .modal-botoes button:first-child { background-color: #6c757d; color: white; }
        .modal-botoes button:last-child { background-color: #007bff; color: white; }
        #settings-fog-enabled, #prop-physics-enabled { width: auto; margin-left: 5px; vertical-align: middle; }

        /* Gerenciador de Arquivos */
        #file-manager-controls { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        #file-tree-container { flex-grow: 1; overflow-y: auto; border: 1px solid var(--cor-borda); border-radius: 4px; padding: 5px; background-color: #2a2a2a; }
        #file-tree { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        #file-tree li { padding: 3px 5px; cursor: pointer; border-radius: 3px; margin-bottom: 1px; display: flex; align-items: center; }
        #file-tree li:hover { background-color: var(--cor-botao-hover); }
        #file-tree li.selected-file { background-color: var(--cor-botao-ativo); font-weight: bold; }
        #file-tree li i { margin-right: 5px; color: #aaa; }
        #file-tree ul { list-style: none; padding-left: 15px; }
        #file-path-display { font-size: 0.85em; color: #bbb; margin-bottom: 5px; white-space: nowrap; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        #file-path-display::-webkit-scrollbar { display: none; }
        .context-menu { position: absolute; background-color: var(--cor-painel); border: 1px solid var(--cor-borda); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 1001; padding: 5px 0; display: none; }
        .context-menu button { display: block; width: 100%; text-align: left; padding: 8px 15px; background: none; border: none; color: var(--cor-texto); cursor: pointer; font-size: 0.9em; }
        .context-menu button:hover { background-color: var(--cor-botao-hover); }
        #modal-save-firebase, #modal-load-firebase, #modal-input { z-index: 1010; }
        #modal-load-firebase .project-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; border: 1px solid var(--cor-borda); border-radius: 4px; background-color: #2a2a2a; margin-bottom: 15px; }
        #modal-load-firebase .project-list li { padding: 8px 10px; border-bottom: 1px solid #3a3a3a; cursor: pointer; transition: background-color 0.1s; }
        #modal-load-firebase .project-list li:last-child { border-bottom: none; }
        #modal-load-firebase .project-list li:hover { background-color: var(--cor-botao-hover); }
        #modal-load-firebase .project-list li.selected { background-color: var(--cor-botao-ativo); font-weight: bold; }
        #modal-load-firebase .project-list li span.date { font-size: 0.8em; color: #aaa; float: right; }

        /* Controles no Canvas */
        #canvas-controls-toolbar {
            position: absolute;
            top: 5px; /* Ajustado para não colar na borda */
            left: 5px;
            background-color: rgba(51, 51, 51, 0.8);
            padding: 5px;
            border-radius: 4px;
            display: none; 
            z-index: 10;
            flex-direction: row; /* Botões em linha */
            gap: 5px;
        }
        #canvas-controls-toolbar button {
            background-color: var(--cor-botao-normal);
            color: white;
            border: none;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 1em; /* Aumenta um pouco para melhor toque */
            transition: background-color 0.2s;
        }
        #canvas-controls-toolbar button:hover {
            background-color: var(--cor-botao-hover);
        }
        #canvas-controls-toolbar button.ativo {
            background-color: var(--cor-botao-ativo);
        }
        #canvas-delete-button {
            position: absolute;
            bottom: 5px; /* Ajustado */
            left: 5px;
            background-color: rgba(220, 53, 69, 0.8); 
            color: white;
            border: none;
            width: 40px; /* Aumentado para melhor toque */
            height: 40px;
            border-radius: 50%;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 1.2em; /* Aumentado */
        }
        #canvas-delete-button:hover {
            background-color: rgba(200, 33, 49, 1);
        }


        @media (min-width: 768px) {
            #main-content-container { flex-direction: row; align-items: stretch; justify-content: space-between; height: calc(100vh - var(--altura-toolbar) - (2 * var(--padding-geral)) - var(--altura-console-desktop) - var(--padding-geral)); } /* Ajusta altura para desktop */
            #left-panel { display: flex; width: 220px; margin-right: var(--padding-geral); }
             #right-panel-container { 
                display: flex; 
                width: 320px; 
                margin-left: 0; 
                order: 2; 
            }
            #cena-3d { margin-left: 0; margin-right: var(--padding-geral); margin-bottom: 0; order: 1;}
            
            #codigo-editor-container { width: 60vw; height: 70vh; }
            #bottom-panel { height: var(--altura-console-desktop); }
        }
    </style>
</head>
<body oncontextmenu="return false;"> 
    <div id="main-toolbar">
        <span class="logo">Motor Monkey</span>
        <button id="btn-toggle-animation" title="Play/Stop Simulação"><i class="fas fa-play"></i></button>
        <button id="btn-toggle-console" title="Mostrar/Esconder Console"><i class="fas fa-terminal"></i></button>
        <button id="btn-add-object" title="Adicionar Objeto"><i class="fas fa-plus"></i> Adicionar</button>
        <button id="btn-open-settings" title="Configurações da Cena"><i class="fas fa-cog"></i></button>
        <button id="btn-toggle-script-editor" title="Editor de Script"><i class="fas fa-code"></i></button>
        <button id="btn-recompile-world" title="Recarregar Mundo Ativo"><i class="fas fa-sync-alt"></i> Recarregar Mundo</button> 
        <button id="btn-generate-script" title="Gerar Script da Cena"><i class="fas fa-file-code"></i></button>
        
        <button id="btn-save-firebase" title="Salvar Projeto na Nuvem"><i class="fas fa-cloud-upload-alt"></i> Salvar Nuvem</button>
        <button id="btn-load-firebase" title="Carregar Projeto da Nuvem"><i class="fas fa-cloud-download-alt"></i> Carregar Nuvem</button>
    </div>

    <div id="main-content-container">
        <div id="left-panel">
            <h4><i class="fas fa-sitemap"></i> Hierarquia</h4>
            <ul id="object-hierarchy"></ul>
            <div id="object-hierarchy-context-menu" class="context-menu">
                <button id="ctx-set-parent"><i class="fas fa-link"></i> Definir como Pai de...</button>
                <button id="ctx-remove-parent"><i class="fas fa-unlink"></i> Tornar Raiz</button>
            </div>
        </div>
        <div id="cena-3d">
            <div id="canvas-controls-toolbar">
                <button id="btn-modo-translate" title="Mover (T)" class="ativo"><i class="fas fa-arrows-alt"></i></button>
                <button id="btn-modo-rotate" title="Rotacionar (R)"><i class="fas fa-sync-alt"></i></button>
                <button id="btn-modo-scale" title="Escalar (S)"><i class="fas fa-expand-alt"></i></button>
            </div>
            <button id="canvas-delete-button" title="Remover Objeto Selecionado"><i class="fas fa-trash-alt"></i></button>
        </div>
        <!-- CONTAINER PARA PAINEL DIREITO E GERENCIADOR DE ARQUIVOS -->
        <div id="right-panel-container">
            <div class="panel-tabs">
                <button id="btn-tab-properties" class="ativo"><i class="fas fa-sliders-h"></i> Propriedades</button>
                <button id="btn-tab-files"><i class="fas fa-folder-open"></i> Arquivos</button>
            </div>
            <div id="right-panel" class="visivel"> <!-- Começa visível -->
                <!-- O h4 foi removido, o título é implícito pela aba -->
                <div id="object-properties"><p>Selecione um objeto para ver suas propriedades.</p></div>
            </div>
            <div id="file-manager-panel"> <!-- Começa escondido -->
                 <h4><i class="fas fa-folder-open"></i> Gerenciador de Arquivos</h4> <!-- Título volta para cá -->
                <div id="file-manager-controls">
                    <input type="file" id="file-upload-input" multiple style="display:none;">
                    <button id="btn-upload-file" title="Upload de Arquivo"><i class="fas fa-upload"></i> Upload</button>
                    <button id="btn-back-folder" title="Voltar"><i class="fas fa-arrow-left"></i> Voltar</button>
                </div>
                <div id="file-path-display">/</div>
                <div id="file-tree-container"> 
                    <ul id="file-tree"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="codigo-editor-container">
        <div id="codigo-editor-header">
            <button id="btn-copy-code" title="Copiar código"><i class="fas fa-copy"></i> Copiar</button>
            <button id="btn-close-script-editor" title="Fechar Editor"><i class="fas fa-times"></i> Fechar</button>
        </div>
        <div id="codigo-editor"></div>
    </div>
    
    <div id="bottom-panel" class="hidden">
        <div id="console-header">
            <h3><i class="fas fa-terminal"></i> Console</h3>
            <div class="console-controls">
                <button class="btn-filter" data-filter="all" title="Mostrar Todos"><i class="fas fa-list"></i></button>
                <button class="btn-filter" data-filter="info" title="Mostrar Informações"><i class="fas fa-info-circle"></i></button>
                <button class="btn-filter" data-filter="warning" title="Mostrar Avisos"><i class="fas fa-exclamation-triangle"></i></button>
                <button class="btn-filter" data-filter="error" title="Mostrar Erros"><i class="fas fa-times-circle"></i></button>
                <button id="btn-copy-console" title="Copiar Logs Visíveis"><i class="fas fa-copy"></i></button>
                <button id="btn-clear-console" title="Limpar Console"><i class="fas fa-trash-alt"></i></button>
            </div>
            <button id="btn-fechar-console" title="Fechar Console"><i class="fas fa-times"></i></button>
        </div>
        <pre id="console-output"></pre>
    </div>

    <div id="modal-adicionar-objeto" class="modal-overlay">
        <div class="modal-conteudo">
             <h3>Adicionar Novo Objeto</h3>
             <label for="modal-obj-name">Nome do Objeto:</label>
             <input type="text" id="modal-obj-name" placeholder="Ex: meu_cubo_1">
             <label for="modal-obj-tipo">Tipo de Objeto:</label>
             <select id="modal-obj-tipo">
                 <optgroup label="Geometrias">
                     <option value="caixa">Caixa</option>
                     <option value="esfera">Esfera</option>
                     <option value="plano">Plano</option>
                 </optgroup>
                 <optgroup label="Câmeras">
                     <option value="camera">Câmera de Jogo</option>
                 </optgroup>
                 <optgroup label="Luzes">
                     <option value="ambiente">Luz Ambiente</option>
                     <option value="direcional">Luz Direcional</option>
                     <option value="ponto">Luz de Ponto</option>
                 </optgroup>
             </select>
             <div class="modal-botoes">
                <button id="btn-cancelar-modal">Cancelar</button>
                <button id="btn-adicionar-modal">Adicionar</button>
             </div>
        </div>
    </div>
    <div id="modal-configuracoes" class="modal-overlay">
         <div class="modal-conteudo">
             <h3>Configurações da Cena</h3>
             <div class="property-group">
                 <h5>Fundo da Cena</h5>
                 <label>Cor de Fundo: <input type="color" id="settings-background-color" value="#1a1a1a"></label>
                 <label>Imagem Ambiente (HDR/JPG/PNG):</label>
                 <div class="texture-input-row">
                     <input type="text" id="settings-environment-map-name" readonly value="Nenhuma">
                     <input type="file" id="settings-environment-map-file" accept="image/*,.hdr" style="display:none">
                     <button id="btn-load-environment-map">Carregar</button>
                     <button id="btn-clear-environment-map">Limpar</button>
                 </div>
             </div>
             <div class="property-group">
                 <h5>Neblina</h5>
                 <label><input type="checkbox" id="settings-fog-enabled"> Habilitar Neblina</label>
                 <div id="settings-fog-options" style="display:none;">
                     <label>Cor: <input type="color" id="settings-fog-color" value="#87ceeb"></label>
                     <label>Início (perto): <input type="number" id="settings-fog-near" step="1" value="20"></label>
                     <label>Fim (longe): <input type="number" id="settings-fog-far" step="1" value="100"></label>
                 </div>
             </div>
             <div class="property-group">
                 <h5>Gravidade (X, Y, Z)</h5>
                 <div class="prop-row">
                     <span class="prop-label">X</span><input type="number" id="settings-gravity-x" step="0.1" value="0">
                     <span class="prop-label">Y</span><input type="number" id="settings-gravity-y" step="0.1" value="-9.82">
                     <span class="prop-label">Z</span><input type="number" id="settings-gravity-z" step="0.1" value="0">
                 </div>
             </div>
             <div class="property-group">
                <h5>Renderização e Qualidade</h5>
                <label for="settings-quality-preset">Preset de Qualidade:</label>
                <select id="settings-quality-preset">
                    <option value="baixa">Baixa</option>
                    <option value="media">Média</option>
                    <option value="alta">Alta</option>
                </select>

                <label><input type="checkbox" id="settings-shadows-enabled"> Sombras Habilitadas</label>
                <div id="settings-shadows-options">
                    <label for="settings-shadows-type">Tipo de Sombra:</label>
                    <select id="settings-shadows-type">
                        <option value="PCFSoftShadowMap">PCFSoftShadowMap (Suave)</option>
                        <option value="BasicShadowMap">BasicShadowMap (Básico)</option>
                        <option value="VSMShadowMap">VSMShadowMap (Experimental)</option>
                    </select>
                    <label for="settings-shadow-map-size">Tamanho do Mapa de Sombras:</label>
                    <input type="number" id="settings-shadow-map-size" step="128" min="256" max="2048" value="1024">
                </div>

                <label><input type="checkbox" id="settings-tone-mapping-enabled"> Tone Mapping Habilitado</label>
                <div id="settings-tone-mapping-options">
                    <label for="settings-tone-mapping-exposure">Exposição do Tone Mapping:</label>
                    <input type="number" id="settings-tone-mapping-exposure" step="0.1" value="1.0">
                </div>

                <label for="settings-pixel-ratio">Resolução (Pixel Ratio): <span id="pixel-ratio-value">1.00</span></label>
                <input type="range" id="settings-pixel-ratio" min="0.5" max="2.0" step="0.05" value="1.0">
             </div>
             <div class="modal-botoes">
                <button id="btn-cancelar-settings">Cancelar</button>
                <button id="btn-salvar-settings">Aplicar</button>
             </div>
         </div>
    </div>
    
    <!-- Context Menu para o Gerenciador de Arquivos -->
    <div id="file-context-menu" class="context-menu">
        <button id="ctx-new-folder"><i class="fas fa-folder-plus"></i> Nova Pasta Aqui</button>
        <button id="ctx-new-world"><i class="fas fa-globe"></i> Novo Mundo Aqui</button>
        <button id="ctx-apply-texture"><i class="fas fa-brush"></i> Aplicar como Textura</button>
        <button id="ctx-open-world"><i class="fas fa-globe-americas"></i> Abrir Mundo</button>
        <button id="ctx-rename-file"><i class="fas fa-edit"></i> Renomear</button>
        <button id="ctx-delete-file"><i class="fas fa-trash-alt"></i> Excluir</button>
    </div>

    <!-- MODAL PARA SALVAR NO FIREBASE -->
    <div id="modal-save-firebase" class="modal-overlay">
        <div class="modal-conteudo">
            <h3>Salvar Projeto na Nuvem</h3>
            <label for="firebase-project-id">ID do Projeto:</label>
            <input type="text" id="firebase-project-id" placeholder="Ex: meu_jogo_01">
            <p style="font-size: 0.8em; color: #ccc;">Apenas letras, números, hífens e underscores.</p>
            <div class="modal-botoes">
                <button id="btn-cancel-save-firebase">Cancelar</button>
                <button id="btn-confirm-save-firebase">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CARREGAR DO FIREBASE -->
    <div id="modal-load-firebase" class="modal-overlay">
        <div class="modal-conteudo">
            <h3>Carregar Projeto da Nuvem</h3>
            <p>Selecione um projeto para carregar:</p>
            <ul class="project-list" id="firebase-project-list">
                <!-- Projetos serão listados aqui -->
                <li>Nenhum projeto encontrado.</li>
            </ul>
            <div class="modal-botoes">
                <button id="btn-cancel-load-firebase">Cancelar</button>
                <button id="btn-confirm-load-firebase" disabled>Carregar Selecionado</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA INPUT DE NOME -->
    <div id="modal-input" class="modal-overlay">
        <div class="modal-conteudo">
            <h3 id="modal-input-title">Digite um nome</h3>
            <label for="modal-input-value" id="modal-input-label">Nome:</label>
            <input type="text" id="modal-input-value" placeholder="Nome do item">
            <p id="modal-input-hint" style="font-size: 0.8em; color: #ccc;"></p>
            <div class="modal-botoes">
                <button id="btn-cancel-input-modal">Cancelar</button>
                <button id="btn-confirm-input-modal">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let motor;
        let aceEditor;
        let objetoSelecionadoId = null;
        let isPlaying = false;
        let currentConsoleFilter = 'all';
        let isPickingChild = false; 
        let prospectiveParentId = null; 

        const fileSystem = {
            'assets': {
                'textures': {},
                'scripts': {},
                'mundos': {}
            }
        }; 
        let currentPath = []; 
        let selectedFileElement = null; 
        let selectedFirebaseProjectId = null; 
        let activeWorldPath = ['assets', 'mundos', 'mundo_padrao.js']; 

        const ui = {
            btnToggleAnimation: document.getElementById('btn-toggle-animation'),
            btnToggleConsole: document.getElementById('btn-toggle-console'),
            btnAddObject: document.getElementById('btn-add-object'),
            btnOpenSettings: document.getElementById('btn-open-settings'),
            btnToggleScriptEditor: document.getElementById('btn-toggle-script-editor'),
            btnRecompileWorld: document.getElementById('btn-recompile-world'), 
            btnGenerateScript: document.getElementById('btn-generate-script'),
            
            btnSaveFirebase: document.getElementById('btn-save-firebase'),
            btnLoadFirebase: document.getElementById('btn-load-firebase'),

            canvasControlsToolbar: document.getElementById('canvas-controls-toolbar'),
            btnModoTranslate: document.getElementById('btn-modo-translate'),
            btnModoRotate: document.getElementById('btn-modo-rotate'),
            btnModoScale: document.getElementById('btn-modo-scale'),
            canvasDeleteButton: document.getElementById('canvas-delete-button'),

            objectHierarchy: document.getElementById('object-hierarchy'),
            objectHierarchyContextMenu: document.getElementById('object-hierarchy-context-menu'), 
            ctxSetParent: document.getElementById('ctx-set-parent'), 
            ctxRemoveParent: document.getElementById('ctx-remove-parent'), 
            objectProperties: document.getElementById('object-properties'),
            rightPanelContainer: document.getElementById('right-panel-container'), 
            btnTabProperties: document.getElementById('btn-tab-properties'),       
            btnTabFiles: document.getElementById('btn-tab-files'),                 
            rightPanel: document.getElementById('right-panel'),                    

            bottomPanel: document.getElementById('bottom-panel'),
            consoleOutput: document.getElementById('console-output'),
            codigoEditorContainer: document.getElementById('codigo-editor-container'),
            btnCloseScriptEditor: document.getElementById('btn-close-script-editor'),
            modalAddObject: document.getElementById('modal-adicionar-objeto'),
            btnAdicionarModal: document.getElementById('btn-adicionar-modal'),
            modalSettings: document.getElementById('modal-configuracoes'),
            btnSaveSettings: document.getElementById('btn-salvar-settings'),
            
            settingsQualityPreset: document.getElementById('settings-quality-preset'),
            settingsShadowsEnabled: document.getElementById('settings-shadows-enabled'),
            settingsShadowsOptions: document.getElementById('settings-shadows-options'),
            settingsShadowsType: document.getElementById('settings-shadows-type'),
            settingsShadowMapSize: document.getElementById('settings-shadow-map-size'),
            settingsToneMappingEnabled: document.getElementById('settings-tone-mapping-enabled'),
            settingsToneMappingOptions: document.getElementById('settings-tone-mapping-options'),
            settingsToneMappingExposure: document.getElementById('settings-tone-mapping-exposure'),
            settingsPixelRatio: document.getElementById('settings-pixel-ratio'),
            pixelRatioValue: document.getElementById('pixel-ratio-value'),
            
            settingsBackgroundColor: document.getElementById('settings-background-color'),
            settingsEnvironmentMapName: document.getElementById('settings-environment-map-name'),
            settingsEnvironmentMapFile: document.getElementById('settings-environment-map-file'),
            btnLoadEnvironmentMap: document.getElementById('btn-load-environment-map'),
            btnClearEnvironmentMap: document.getElementById('btn-clear-environment-map'),

            // btnToggleFileManager: document.getElementById('btn-toggle-file-manager'), // REMOVIDO
            fileManagerPanel: document.getElementById('file-manager-panel'),
            fileUploadInput: document.getElementById('file-upload-input'),
            btnUploadFile: document.getElementById('btn-upload-file'),
            btnBackFolder: document.getElementById('btn-back-folder'),
            filePathDisplay: document.getElementById('file-path-display'),
            fileTree: document.getElementById('file-tree'),
            fileTreeContainer: document.getElementById('file-tree-container'), 
            fileContextMenu: document.getElementById('file-context-menu'),
            ctxNewFolder: document.getElementById('ctx-new-folder'),       
            ctxNewWorld: document.getElementById('ctx-new-world'),         
            ctxApplyTexture: document.getElementById('ctx-apply-texture'),
            ctxOpenWorld: document.getElementById('ctx-open-world'), 
            ctxRenameFile: document.getElementById('ctx-rename-file'),
            ctxDeleteFile: document.getElementById('ctx-delete-file'),

            modalSaveFirebase: document.getElementById('modal-save-firebase'),
            firebaseProjectIdInput: document.getElementById('firebase-project-id'),
            btnCancelSaveFirebase: document.getElementById('btn-cancel-save-firebase'),
            btnConfirmSaveFirebase: document.getElementById('btn-confirm-save-firebase'),

            modalLoadFirebase: document.getElementById('modal-load-firebase'),
            firebaseProjectList: document.getElementById('firebase-project-list'),
            btnCancelLoadFirebase: document.getElementById('btn-cancel-load-firebase'),
            btnConfirmLoadFirebase: document.getElementById('btn-confirm-load-firebase'),
            
            modalInput: document.getElementById('modal-input'),
            modalInputTitle: document.getElementById('modal-input-title'),
            modalInputLabel: document.getElementById('modal-input-label'),
            modalInputValue: document.getElementById('modal-input-value'),
            modalInputHint: document.getElementById('modal-input-hint'),
            btnCancelInputModal: document.getElementById('btn-cancel-input-modal'),
            btnConfirmInputModal: document.getElementById('btn-confirm-input-modal')
        };
        let currentInputModalCallback = null; 

        function init() {
            motor = new MotorJM('cena-3d', fileSystem); 
            motor.iniciar();
            setupAceEditor();
            setupEventListeners();
            createDefaultWorldIfNotExists();
            loadWorldScriptToEditor(activeWorldPath); 
            recarregarMundoAtivo(); 
            updateUI();
            logConsole('info', 'Editor inicializado. Bem-vindo ao Motor Monkey!');
            updateConsoleFilter('all');
            loadGraphicSettingsUI();
            renderFileTree(); 
            showPropertiesPanel(); 
        }
        
        function createDefaultWorldIfNotExists() {
            const defaultWorldName = 'mundo_padrao.js';
            let mundosFolder = getFolder(['assets', 'mundos']);
            if (!mundosFolder) { 
                 const assetsFolder = getFolder(['assets']);
                 if (assetsFolder) {
                    assetsFolder['mundos'] = {};
                    mundosFolder = assetsFolder['mundos'];
                 } else { 
                    fileSystem['assets'] = { textures: {}, scripts: {}, mundos: {} };
                    mundosFolder = fileSystem.assets.mundos;
                 }
            }

            if (mundosFolder && !mundosFolder[defaultWorldName]) {
                const defaultScriptContent = `// Mundo Padrão - Motor Monkey\nconsole.log("Mundo Padrão Carregado!");\n`;
                mundosFolder[defaultWorldName] = {
                    type: 'script',
                    content: defaultScriptContent,
                    url: `data:application/javascript;base64,${btoa(encodeURIComponent(defaultScriptContent))}`
                };
                activeWorldPath = ['assets', 'mundos', defaultWorldName];
            }
        }

        function setupAceEditor() {
            aceEditor = ace.edit('codigo-editor');
            aceEditor.setTheme("ace/theme/monokai");
            aceEditor.session.setMode("ace/mode/javascript");
        }

        function logConsole(type, message) {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (currentConsoleFilter !== 'all' && type !== currentConsoleFilter) {
                span.style.display = 'none';
            }
            ui.consoleOutput.appendChild(span);
            ui.consoleOutput.scrollTop = ui.consoleOutput.scrollHeight;
        }

        function updateConsoleFilter(newFilter) {
            currentConsoleFilter = newFilter;
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.toggle('ativo', btn.dataset.filter === newFilter);
            });
            ui.consoleOutput.querySelectorAll('span').forEach(span => {
                const isVisible = (newFilter === 'all' || span.classList.contains(newFilter));
                span.style.display = isVisible ? 'block' : 'none';
            });
        }

        function copyConsoleOutput() {
            const visibleLogs = Array.from(ui.consoleOutput.querySelectorAll('span'))
                .filter(span => span.style.display !== 'none')
                .map(span => span.textContent)
                .join('\n');
            if (visibleLogs) {
                navigator.clipboard.writeText(visibleLogs).then(() => {
                    logConsole('info', 'Logs visíveis copiados para a área de transferência.');
                }, () => {
                    logConsole('error', 'Falha ao copiar os logs.');
                });
            } else {
                logConsole('warning', 'Nenhum log visível para copiar.');
            }
        }
        
        function recarregarMundoAtivo() { 
            if (isPlaying) togglePlayStop(); 
            try { 
                motor.limparCena(); 
                const currentWorldScript = aceEditor.getValue(); 
                motor.executeScript(currentWorldScript, activeWorldPath.join('/')); 
                logConsole('info', `Mundo "${activeWorldPath.join('/')}" recarregado com sucesso.`); 
            } catch (e) { 
                logConsole('error', `Erro ao executar script do mundo: ${e.message}`); 
                console.error(e); 
            } 
            updateHierarchy(); 
            updatePropertiesPanel(null); 
            loadGraphicSettingsUI(); 
        }

        function togglePlayStop() { isPlaying = !isPlaying; const icon = ui.btnToggleAnimation.querySelector('i'); const leftPanel = document.getElementById('left-panel'); const rightPanelContainer = document.getElementById('right-panel-container'); 
            if (isPlaying) { 
                motor.play(); 
                icon.classList.replace('fa-play', 'fa-stop'); 
                ui.btnToggleAnimation.title = "Parar Simulação"; 
                [leftPanel, rightPanelContainer, ui.canvasControlsToolbar, ui.canvasDeleteButton].forEach(p => {if(p){p.style.pointerEvents = "none"; p.style.opacity = "0.5";}}); 
            } else { 
                motor.parar(); 
                icon.classList.replace('fa-stop', 'fa-play'); 
                ui.btnToggleAnimation.title = "Iniciar Simulação"; 
                [leftPanel, rightPanelContainer, ui.canvasControlsToolbar, ui.canvasDeleteButton].forEach(p => {if(p){p.style.pointerEvents = "auto"; p.style.opacity = "1";}}); 
                updateCanvasControlsVisibility(); 
            } 
        }
        function adicionarNovoObjeto() {
            const name = document.getElementById('modal-obj-name').value || 'novo_objeto';
            const id = `${name.replace(/\s+/g, '_').toLowerCase()}_${Date.now()}`;
            const type = document.getElementById('modal-obj-tipo').value;
            const isLight = ['ambiente', 'direcional', 'ponto'].includes(type);

            if (isLight) {
                motor.adicionarObjeto(id, name, { type: type, color: '#ffffff', intensity: 1 });
            } else if (type === 'camera') { 
                motor.adicionarObjeto(id, name, 'camera', { position: {x:0, y:5, z:15}, fov: 75, near: 0.1, far: 1000 });
            }
            else {
                const bodyType = (type === 'plano') ? 'static' : 'dynamic';
                const collisionShape = (type === 'plano') ? 'plane' : (type === 'esfera' ? 'sphere' : 'box'); 
                motor.adicionarObjeto(id, name, type, { physics: { bodyType: bodyType, mass: 1, friction: 0.5, restitution: 0.5, collisionShape: collisionShape, linearDamping: 0.01, angularDamping: 0.01 } });
            }
            updateHierarchy();
            selecionarObjeto(id);
            toggleModal(ui.modalAddObject, false);
        }
        function gerarESetarScript() { const script = motor.gerarScriptDaCena(); aceEditor.setValue(script, -1); logConsole('info', 'Script da cena atual gerado no editor.'); toggleScriptEditor(true); }
        
        // --- FUNÇÕES DE SALVAMENTO/CARREGAMENTO FIREBASE ---
        async function salvarProjetoFirebase() {
            if (!window.firebaseRefs || !window.firebaseRefs.getDatabase) {
                logConsole('error', 'Firebase Database não inicializado. Verifique a configuração.');
                return;
            }

            ui.firebaseProjectIdInput.value = ''; 
            ui.firebaseProjectIdInput.focus(); 
            toggleModal(ui.modalSaveFirebase, true);
        }

        async function confirmSaveFirebase() {
            const projectIdRaw = ui.firebaseProjectIdInput.value.trim();
            const firebase = window.firebaseRefs; 
            const projectId = motor._firebaseEncodeKey(projectIdRaw); 

            if (!projectId) {
                logConsole('warning', 'Salvamento cancelado: ID do projeto não fornecido.');
                toggleModal(ui.modalSaveFirebase, false);
                return;
            }

            logConsole('info', `Preparando para salvar projeto "${projectIdRaw}" no Firebase...`);
            toggleModal(ui.modalSaveFirebase, false); 

            const activeWorldScriptContent = aceEditor.getValue();
            const activeWorldFolder = getFolder(activeWorldPath.slice(0, -1)); 
            if (activeWorldFolder) {
                const activeWorldFileName = activeWorldPath[activeWorldPath.length - 1];
                const encodedFileName = motor._firebaseEncodeKey(activeWorldFileName);
                 activeWorldFolder[encodedFileName] = { 
                    type: 'script',
                    content: activeWorldScriptContent, 
                    url: `data:application/javascript;base64,${btoa(encodeURIComponent(activeWorldScriptContent))}` 
                };
            }

            const projectData = motor.gerarDadosDoProjeto(aceEditor.getValue(), fileSystem, true, activeWorldPath); 

            try {
                await firebase.set(firebase.ref(firebase.getDatabase(), 'projects/' + projectId), {
                    lastUpdated: new Date().toISOString(), 
                    projectContent: projectData 
                });
                logConsole('info', `Projeto "${projectIdRaw}" salvo no Firebase com sucesso!`);
            } catch (error) {
                logConsole('error', `Falha ao salvar o projeto "${projectIdRaw}" no Firebase: ${error.message}`);
                console.error("Firebase (Erro Salvamento):", error);
                if (error.code === 'PERMISSION_DENIED') {
                    logConsole('error', 'Erro de permissão no Firebase. Verifique suas regras de segurança no console do Firebase.');
                }
            }
        }

        async function carregarProjetoFirebase() {
            const firebase = window.firebaseRefs;

            if (!firebase || !firebase.getDatabase) {
                logConsole('error', 'Firebase Database não inicializado. Verifique a configuração.');
                return;
            }
            
            ui.firebaseProjectList.innerHTML = '<li>Carregando projetos...</li>'; 
            ui.btnConfirmLoadFirebase.disabled = true; 
            selectedFirebaseProjectId = null; 

            toggleModal(ui.modalLoadFirebase, true);

            try {
                const dbRef = firebase.ref(firebase.getDatabase());
                const snapshot = await firebase.get(firebase.child(dbRef, 'projects'));
                
                ui.firebaseProjectList.innerHTML = ''; 
                if (snapshot.exists()) {
                    const projects = snapshot.val();
                    let hasProjects = false;
                    for (const id in projects) {
                        const projectInfo = projects[id];
                        const li = document.createElement('li');
                        li.textContent = `${motor._firebaseDecodeKey(id)}`; 
                        if (projectInfo.lastUpdated) {
                            li.innerHTML += ` <span class="date">(${new Date(projectInfo.lastUpdated).toLocaleString()})</span>`;
                        }
                        li.dataset.projectId = id; 
                        li.addEventListener('click', () => {
                            Array.from(ui.firebaseProjectList.children).forEach(child => child.classList.remove('selected'));
                            li.classList.add('selected');
                            selectedFirebaseProjectId = id; 
                            ui.btnConfirmLoadFirebase.disabled = false;
                        });
                        ui.firebaseProjectList.appendChild(li);
                        hasProjects = true;
                    }
                    if (!hasProjects) {
                         ui.firebaseProjectList.innerHTML = '<li>Nenhum projeto encontrado.</li>';
                    }
                } else {
                    ui.firebaseProjectList.innerHTML = '<li>Nenhum projeto encontrado.</li>';
                }
            } catch (error) {
                logConsole('error', `Falha ao listar projetos do Firebase: ${error.message}`);
                console.error("Firebase (Erro Listagem):", error);
                ui.firebaseProjectList.innerHTML = '<li>Erro ao carregar projetos.</li>';
            }
        }

        async function confirmLoadFirebase() {
            if (!selectedFirebaseProjectId) {
                logConsole('warning', 'Nenhum projeto selecionado para carregar.');
                return;
            }

            const firebase = window.firebaseRefs;
            logConsole('info', `Carregando projeto "${motor._firebaseDecodeKey(selectedFirebaseProjectId)}" do Firebase...`);
            toggleModal(ui.modalLoadFirebase, false); 

            try {
                const dbRef = firebase.ref(firebase.getDatabase());
                const snapshot = await firebase.get(firebase.child(dbRef, 'projects/' + selectedFirebaseProjectId));
                if (snapshot.exists()) {
                    const loadedData = snapshot.val().projectContent; 
                    
                    motor.limparCena(); // Limpa a cena ATUAL antes de aplicar os dados do novo projeto
                    
                    motor.aplicarDadosDoProjeto(loadedData, aceEditor, fileSystem, (newActiveWorldPath) => {
                        activeWorldPath = newActiveWorldPath; 
                    }); 
                    logConsole('info', `Projeto "${motor._firebaseDecodeKey(selectedFirebaseProjectId)}" carregado do Firebase com sucesso!`);
                    renderFileTree();
                    loadGraphicSettingsUI(); 
                    recarregarMundoAtivo(); 
                } else {
                    logConsole('error', `Erro: Projeto "${motor._firebaseDecodeKey(selectedFirebaseProjectId)}" não encontrado ao tentar carregar.`);
                }
            } catch (error) {
                logConsole('error', `Falha ao carregar o projeto "${motor._firebaseDecodeKey(selectedFirebaseProjectId)}" do Firebase: ${error.message}`);
                console.error("Firebase (Erro Carregamento):", error);
                if (error.code === 'PERMISSION_DENIED') {
                    logConsole('error', 'Erro de permissão no Firebase. Verifique suas regras de segurança no console do Firebase.');
                }
            }
        }

        function hideFirebaseModals() {
            toggleModal(ui.modalSaveFirebase, false);
            toggleModal(ui.modalLoadFirebase, false);
        }
        
        // --- FUNÇÕES DO MODAL DE INPUT GENÉRICO ---
        function showInputModal(title, label, hint, defaultValue, callback) {
            ui.modalInputTitle.textContent = title;
            ui.modalInputLabel.textContent = label;
            ui.modalInputHint.textContent = hint || '';
            ui.modalInputValue.value = defaultValue || '';
            ui.modalInputValue.placeholder = label.replace(':', '');
            currentInputModalCallback = callback;
            toggleModal(ui.modalInput, true);
            ui.modalInputValue.focus();
            ui.modalInputValue.select();
        }

        function confirmInputModal() {
            if (currentInputModalCallback) {
                currentInputModalCallback(ui.modalInputValue.value);
            }
            hideInputModal();
        }

        function hideInputModal() {
            toggleModal(ui.modalInput, false);
            currentInputModalCallback = null;
        }


        function updateUI() { 
            const showPanels = window.innerWidth >= 768; 
            document.getElementById('left-panel').style.display = showPanels ? 'flex' : 'none'; 
            document.getElementById('right-panel-container').style.display = showPanels ? 'flex' : 'none';
        }
        
        // --- HIERARQUIA DE OBJETOS ---
        function updateHierarchy() {
            ui.objectHierarchy.innerHTML = '';
            const objects = motor.getObjetosNaCena();
            const rootObjects = Object.values(objects).filter(obj => !obj.parentId && !obj.id.endsWith('_padrao'));

            const createHierarchyNode = (obj, parentElement, level = 0) => {
                const li = document.createElement('li');
                li.style.paddingLeft = `${level * 10}px`; // Indentação
                li.dataset.id = obj.id;

                const toggle = document.createElement('span');
                toggle.className = 'hierarchy-toggle';
                
                let iconClass = 'fa-cube';
                if (obj.type === 'esfera') iconClass = 'fa-globe';
                if (obj.type.startsWith('luz')) iconClass = 'fa-lightbulb';
                if (obj.type === 'plano') iconClass = 'fa-square-full';
                if (obj.type === 'camera_jogo') iconClass = 'fa-video';

                const iconElement = document.createElement('i');
                iconElement.className = `fas ${iconClass}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = ` ${obj.name || obj.id}`;

                li.appendChild(toggle);
                li.appendChild(iconElement);
                li.appendChild(nameSpan);

                if (obj.id === objetoSelecionadoId) {
                    li.classList.add('selected');
                }

                li.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if (isPickingChild) {
                        if (prospectiveParentId && prospectiveParentId !== obj.id) {
                             motor.setParent(obj.id, prospectiveParentId);
                             updateHierarchy();
                             logConsole('info', `Objeto "${obj.name || obj.id}" definido como filho de "${motor.getObjetosNaCena()[prospectiveParentId].name || prospectiveParentId}".`);
                        }
                        isPickingChild = false;
                        prospectiveParentId = null;
                        document.body.style.cursor = 'default';
                        document.removeEventListener('keydown', handlePickingChildEscape, true);
                        document.removeEventListener('click', handlePickingChildClick, true);
                    } else {
                        selecionarObjeto(obj.id);
                    }
                });
                li.addEventListener('contextmenu', (e) => showObjectHierarchyContextMenu(e, obj.id));

                parentElement.appendChild(li);

                if (obj.childrenIds && obj.childrenIds.length > 0) {
                    toggle.innerHTML = obj.isExpanded ? '<i class="fas fa-caret-down"></i>' : '<i class="fas fa-caret-right"></i>';
                    toggle.onclick = (e) => {
                        e.stopPropagation();
                        obj.isExpanded = !obj.isExpanded;
                        updateHierarchy(); 
                    };
                    if (obj.isExpanded) {
                        const ul = document.createElement('ul');
                        parentElement.appendChild(ul);
                        obj.childrenIds.forEach(childId => {
                            const childObj = objects[childId];
                            if (childObj) createHierarchyNode(childObj, ul, level + 1);
                        });
                    }
                } else {
                    toggle.classList.add('empty'); 
                }
            };

            rootObjects.sort((a,b) => (a.name || a.id).localeCompare(b.name || b.id)).forEach(obj => createHierarchyNode(obj, ui.objectHierarchy));
        }


        function showObjectHierarchyContextMenu(event, objectId) {
            event.preventDefault();
            event.stopPropagation(); 
            hideFileContextMenu(); 
            hideObjectHierarchyContextMenu(); 

            const obj = motor.getObjetosNaCena()[objectId];
            if (!obj) return;

            ui.ctxSetParent.style.display = 'block';
            ui.ctxRemoveParent.style.display = obj.parentId ? 'block' : 'none';

            ui.objectHierarchyContextMenu.style.left = `${event.clientX}px`;
            ui.objectHierarchyContextMenu.style.top = `${event.clientY}px`;
            ui.objectHierarchyContextMenu.style.display = 'block';

            ui.objectHierarchyContextMenu.dataset.objectId = objectId;

            document.addEventListener('click', hideObjectHierarchyContextMenu, { once: true });
        }

        function hideObjectHierarchyContextMenu() {
            ui.objectHierarchyContextMenu.style.display = 'none';
        }
        
        function handlePickingChildEscape(e) {
            if (e.key === 'Escape') {
                isPickingChild = false;
                prospectiveParentId = null;
                document.body.style.cursor = 'default';
                logConsole('info', 'Seleção de filho cancelada.');
                document.removeEventListener('keydown', handlePickingChildEscape, true);
                document.removeEventListener('click', handlePickingChildClick, true);
            }
        }

        function handlePickingChildClick(e) {
            if (isPickingChild && !e.target.closest('button, input, select, textarea, .context-menu, .modal-overlay')) {
                // Se o clique não foi em um objeto válido da hierarquia, cancela
                const clickedLi = e.target.closest('#object-hierarchy li');
                if (!clickedLi || !clickedLi.dataset.id) {
                    isPickingChild = false;
                    prospectiveParentId = null;
                    document.body.style.cursor = 'default';
                    logConsole('info', 'Seleção de filho cancelada (clique fora de um objeto).');
                }
                // A lógica de definir o pai acontece no event listener do clique do item da hierarquia
                document.removeEventListener('keydown', handlePickingChildEscape, true);
                document.removeEventListener('click', handlePickingChildClick, true);
            }
        }


        function handleSetParent() {
            prospectiveParentId = ui.objectHierarchyContextMenu.dataset.objectId;
            if (!prospectiveParentId) return;

            isPickingChild = true;
            document.body.style.cursor = 'crosshair'; 
            logConsole('info', `Selecione um objeto na cena ou na hierarquia para torná-lo filho de "${motor.getObjetosNaCena()[prospectiveParentId].name || prospectiveParentId}". Pressione ESC para cancelar.`);
            hideObjectHierarchyContextMenu();
            document.addEventListener('keydown', handlePickingChildEscape, true);
            document.addEventListener('click', handlePickingChildClick, true);
        }

        function handleRemoveParent() {
            const childId = ui.objectHierarchyContextMenu.dataset.objectId;
            if (childId) {
                motor.removeParent(childId);
                updateHierarchy();
            }
            hideObjectHierarchyContextMenu();
        }



        // Função para controlar a visibilidade dos controles do canvas
        function updateCanvasControlsVisibility() {
            const show = objetoSelecionadoId && !isPlaying;
            ui.canvasControlsToolbar.style.display = show ? 'flex' : 'none';
            ui.canvasDeleteButton.style.display = show ? 'flex' : 'none';
        }

        function selecionarObjeto(id) { 
            if(isPlaying) return; 
            if (isPickingChild) { 
                if (prospectiveParentId && prospectiveParentId !== id) {
                     motor.setParent(id, prospectiveParentId);
                     updateHierarchy();
                     logConsole('info', `Objeto "${motor.getObjetosNaCena()[id]?.name || id}" definido como filho de "${motor.getObjetosNaCena()[prospectiveParentId]?.name || prospectiveParentId}".`);
                }
                isPickingChild = false;
                prospectiveParentId = null;
                document.body.style.cursor = 'default';
                document.removeEventListener('keydown', handlePickingChildEscape, true);
                document.removeEventListener('click', handlePickingChildClick, true);
                
                if (objetoSelecionadoId === prospectiveParentId) {
                    // Mantém o pai selecionado
                } else if (prospectiveParentId) {
                    // Seleciona o pai se ele não era o objeto selecionado
                    selecionarObjeto(prospectiveParentId); 
                }
                return; 
            }

            objetoSelecionadoId = id; 
            motor.selecionarObjeto(id); 
            updateHierarchy(); 
            updatePropertiesPanel(id);
            updateCanvasControlsVisibility(); 
        }


        function updatePropertiesPanel(id) {
            if (!id || !motor) {
                ui.objectProperties.innerHTML = '<p>Selecione um objeto para ver suas propriedades.</p>';
                updateCanvasControlsVisibility(); 
                return;
            }
            const obj = motor.getObjetosNaCena()[id];
            if (!obj) {
                updateCanvasControlsVisibility(); 
                return;
            }
            updateCanvasControlsVisibility(); 

            let html = `<h5>${obj.name || id}</h5>`;
            const threeObj = obj.threeObj;

            if (threeObj.position) {
                const pos = threeObj.position;
                const rot = threeObj.rotation;
                const scale = threeObj.scale; 
                html += `<div class="property-group"><h5>Transform</h5>
                    <div class="prop-row"><span class="prop-label">P</span>
                        <input type="number" step="0.1" value="${pos.x.toFixed(2)}" data-prop="position.x" data-type="float">
                        <input type="number" step="0.1" value="${pos.y.toFixed(2)}" data-prop="position.y" data-type="float">
                        <input type="number" step="0.1" value="${pos.z.toFixed(2)}" data-prop="position.z" data-type="float">
                    </div>
                    <div class="prop-row"><span class="prop-label">R</span>
                        <input type="number" step="1" value="${(rot.x * 180 / Math.PI).toFixed(1)}" data-prop="rotation.x" data-type="degrees">
                        <input type="number" step="1" value="${(rot.y * 180 / Math.PI).toFixed(1)}" data-prop="rotation.y" data-type="degrees">
                        <input type="number" step="1" value="${(rot.z * 180 / Math.PI).toFixed(1)}" data-prop="rotation.z" data-type="degrees">
                    </div>
                    <div class="prop-row"><span class="prop-label">S</span> 
                        <input type="number" step="0.1" value="${scale.x.toFixed(2)}" data-prop="scale.x" data-type="float">
                        <input type="number" step="0.1" value="${scale.y.toFixed(2)}" data-prop="scale.y" data-type="float">
                        <input type="number" step="0.1" value="${scale.z.toFixed(2)}" data-prop="scale.z" data-type="float">
                    </div>
                </div>`;
            }

            if (obj.type === 'camera_jogo') {
                html += `<div class="property-group"><h5>Câmera de Jogo</h5>
                    <label>FOV: <input type="number" step="1" value="${obj.threeObj.fov.toFixed(1)}" data-prop="fov" data-type="float"></label>
                    <label>Near: <input type="number" step="0.1" value="${obj.threeObj.near.toFixed(2)}" data-prop="near" data-type="float"></label>
                    <label>Far: <input type="number" step="1" value="${obj.threeObj.far.toFixed(2)}" data-prop="far" data-type="float"></label>
                </div>`;
            }

            if (obj.type.startsWith('luz_')) {
                 html += `<div class="property-group"><h5>Luz</h5>
                    <label>Cor</label>
                    <input type="color" value="#${threeObj.color.getHexString()}" data-prop="color">
                    <label>Intensidade: <input type="number" step="0.05" value="${threeObj.intensity.toFixed(2)}" data-prop="intensity" data-type="float"></label>
                </div>`;
            }

            if (threeObj.isMesh && threeObj.material) {
                const mat = threeObj.material;
                const getTexName = (tex) => tex ? tex.name || 'arquivo_local.png' : 'Nenhuma';
                html += `<div class="property-group"><h5>Material (PBR)</h5>
                    <label>Albedo (Cor)</label>
                    <input type="color" value="#${mat.color.getHexString()}" data-prop="material.color">
                    <div class="texture-input-row">
                        <input type="text" readonly value="${getTexName(mat.map)}" title="${getTexName(mat.map)}">
                        <input type="file" id="tex-albedo-${id}" accept="image/*" style="display:none" data-map-type="map">
                        <button class="btn-load-texture" data-target-file-input="tex-albedo-${id}">Carregar</button>
                    </div>
                    <label>Metalness: <input type="number" min="0" max="1" step="0.01" value="${mat.metalness.toFixed(2)}" data-prop="material.metalness" data-type="float"></label>
                    <label>Roughness: <input type="number" min="0" max="1" step="0.01" value="${mat.roughness.toFixed(2)}" data-prop="material.roughness" data-type="float"></label>
                </div>`;
            }

            if (obj.physicsProperties) { 
                const physicsProps = obj.physicsProperties;
                html += `<div class="property-group"><h5>Física</h5>
                    <label>Tipo de Corpo:</label>
                    <select data-prop="physics.bodyType">
                        <option value="dynamic" ${physicsProps.bodyType === 'dynamic' ? 'selected' : ''}>Dinâmico</option>
                        <option value="static" ${physicsProps.bodyType === 'static' ? 'selected' : ''}>Estático</option>
                        <option value="none" ${physicsProps.bodyType === 'none' ? 'selected' : ''}>Nenhum</option>
                    </select>
                    <div id="physics-options-${id}" style="display:${physicsProps.bodyType === 'none' ? 'none' : 'block'};">
                        <label>Forma de Colisão:</label>
                        <select data-prop="physics.collisionShape" ${physicsProps.bodyType === 'none' ? 'disabled' : ''}>
                            <option value="box" ${physicsProps.collisionShape === 'box' ? 'selected' : ''}>Caixa</option>
                            <option value="sphere" ${physicsProps.collisionShape === 'sphere' ? 'selected' : ''}>Esfera</option>
                            <option value="plane" ${physicsProps.collisionShape === 'plane' ? 'selected' : ''}>Plano</option>
                        </select>
                        <label>Massa: <input type="number" step="0.1" value="${physicsProps.mass}" data-prop="physics.mass" data-type="float" ${physicsProps.bodyType === 'dynamic' ? '' : 'disabled'}></label>
                        <label>Fricção: <input type="number" min="0" max="1" step="0.01" value="${physicsProps.friction.toFixed(2)}" data-prop="physics.friction" data-type="float" ${physicsProps.bodyType === 'none' ? 'disabled' : ''}></label>
                        <label>Restituição (Quique): <input type="number" min="0" max="1" step="0.01" value="${physicsProps.restitution.toFixed(2)}" data-prop="physics.restitution" data-type="float" ${physicsProps.bodyType === 'none' ? 'disabled' : ''}></label>
                        <label>Atrito Linear (Ar): <input type="number" min="0" max="1" step="0.01" value="${(physicsProps.linearDamping ?? 0.01).toFixed(2)}" data-prop="physics.linearDamping" data-type="float" ${physicsProps.bodyType === 'none' ? 'disabled' : ''}></label>
                        <label>Atrito Angular (Ar): <input type="number" min="0" max="1" step="0.01" value="${(physicsProps.angularDamping ?? 0.01).toFixed(2)}" data-prop="physics.angularDamping" data-type="float" ${physicsProps.bodyType === 'none' ? 'disabled' : ''}></label>
                    </div>
                </div>`;
            }
            
            ui.objectProperties.innerHTML = html;
            addPropertyListeners(id); 
        }

        function addPropertyListeners(id) {
            const container = ui.objectProperties;

            container.querySelectorAll('input[data-prop]:not([type="radio"]), select[data-prop]').forEach(input => {
                input.addEventListener('input', (e) => { 
                    const prop = e.target.dataset.prop;
                    let value;

                    if (e.target.type === 'checkbox') {
                        value = e.target.checked;
                    } else if (e.target.dataset.type === 'float') {
                        value = parseFloat(e.target.value);
                    } else if (e.target.dataset.type === 'degrees') {
                        value = parseFloat(e.target.value) * Math.PI / 180;
                    } else {
                        value = e.target.value; 
                    }
                    motor.atualizarPropriedadeObjeto(id, prop, value);
                    if (prop === 'physics.bodyType') {
                        updatePropertiesPanel(id); 
                    }
                });
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', (e) => {
                         motor.atualizarPropriedadeObjeto(id, e.target.dataset.prop, e.target.value);
                         if (e.target.dataset.prop === 'physics.bodyType') {
                             updatePropertiesPanel(id); 
                         }
                    });
                }
            });

            container.querySelectorAll('.btn-load-texture').forEach(button => {
                button.addEventListener('click', (e) => { document.getElementById(e.target.dataset.targetFileInput).click(); });
            });
            container.querySelectorAll('input[type="file"][data-map-type]').forEach(fileInput => {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const mapType = e.target.dataset.mapType;
                    const reader = new FileReader();
                    reader.onload = (readEvent) => {
                        const dataUrl = readEvent.target.result;
                        motor.atualizarPropriedadeObjeto(id, `material.${mapType}`, { url: dataUrl, name: file.name });
                        logConsole('info', `Carregando textura '${file.name}' para ${mapType}.`);
                        e.target.parentElement.querySelector('input[type="text"]').value = file.name;
                        
                        const texturesFolder = getFolder(['assets', 'textures']);
                        if (texturesFolder && !texturesFolder[file.name]) { 
                            texturesFolder[file.name] = {
                                type: 'image',
                                url: dataUrl, 
                                content: null 
                            };
                            renderFileTree();
                            logConsole('info', `Textura '${file.name}' adicionada ao gerenciador de arquivos.`);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            });
        }
        
        // --- Funções de Configuração Gráfica na UI ---

        function loadGraphicSettingsUI() {
            const renderer = motor.renderizador;
            const currentLight = Object.values(motor.getObjetosNaCena()).find(o => o.threeObj.isDirectionalLight)?.threeObj;
            const currentShadowMapSize = currentLight?.shadow?.mapSize.width || 1024;

            ui.settingsShadowsEnabled.checked = renderer.shadowMap.enabled;
            ui.settingsShadowsType.value = Object.keys(THREE).find(key => THREE[key] === renderer.shadowMap.type) || 'PCFSoftShadowMap';
            ui.settingsShadowMapSize.value = currentShadowMapSize;

            ui.settingsToneMappingEnabled.checked = renderer.toneMapping !== THREE.NoToneMapping;
            ui.settingsToneMappingExposure.value = renderer.toneMappingExposure.toFixed(2);

            ui.settingsPixelRatio.value = renderer.getPixelRatio().toFixed(2);
            ui.pixelRatioValue.textContent = renderer.getPixelRatio().toFixed(2);

            ui.settingsShadowsOptions.style.display = ui.settingsShadowsEnabled.checked ? 'block' : 'none';
            ui.settingsToneMappingOptions.style.display = ui.settingsToneMappingEnabled.checked ? 'block' : 'none';

            ui.settingsBackgroundColor.value = `#${motor.cena.background?.getHexString() || '1a1a1a'}`;
            ui.settingsEnvironmentMapName.value = motor.cena._backgroundConfig.environmentMapName || 'Nenhuma';
        }

        function applyGraphicSettings() {
            const settings = {
                sombrasHabilitadas: ui.settingsShadowsEnabled.checked,
                tipoSombra: ui.settingsShadowsType.value,
                toneMappingHabilitado: ui.settingsToneMappingEnabled.checked,
                exposicaoToneMapping: parseFloat(ui.settingsToneMappingExposure.value),
                pixelRatio: parseFloat(ui.settingsPixelRatio.value),
                shadowMapSize: parseInt(ui.settingsShadowMapSize.value)
            };
            motor.aplicarConfiguracoesDeRenderizacao(settings);
            
            const backgroundSettings = {
                color: ui.settingsBackgroundColor.value,
                environmentMap: ui.settingsEnvironmentMapFile.files[0] || null 
            };
            motor.configurarFundoCena(backgroundSettings);

            logConsole('info', 'Configurações de renderização aplicadas.');
        }

        // --- Gerenciador de Arquivos Lógica ---

        function getFolder(path) {
            let currentFolder = fileSystem;
            for (const p of path) {
                if (!currentFolder[p] || typeof currentFolder[p] !== 'object' || currentFolder[p].type) {
                    return null; 
                }
                currentFolder = currentFolder[p];
            }
            return currentFolder;
        }

        function renderFileTree() {
            ui.fileTree.innerHTML = '';
            const currentFolder = getFolder(currentPath);
            ui.filePathDisplay.textContent = '/' + currentPath.join('/');

            if (!currentFolder) {
                logConsole('error', 'Caminho do gerenciador de arquivos inválido. Resetando para a raiz.');
                currentPath = [];
                renderFileTree();
                return;
            }

            const folders = [];
            const files = [];

            for (const name in currentFolder) {
                if (currentFolder[name] && currentFolder[name].type) { 
                    files.push({ name, data: currentFolder[name] });
                } else { 
                    folders.push({ name, data: currentFolder[name] });
                }
            }

            folders.sort((a, b) => a.name.localeCompare(b.name));
            files.sort((a, b) => a.name.localeCompare(b.name));

            folders.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-folder"></i> ${item.name}`;
                li.dataset.name = item.name;
                li.dataset.type = 'folder';
                li.addEventListener('click', () => {
                    currentPath.push(item.name);
                    renderFileTree();
                    selectedFileElement = null; 
                });
                li.addEventListener('contextmenu', (e) => showFileContextMenu(e, item.name, 'folder'));
                ui.fileTree.appendChild(li);
            });

            files.forEach(item => {
                const li = document.createElement('li');
                let iconClass = 'fa-file-alt'; 
                if (item.name.match(/\.(png|jpg|jpeg|gif|hdr)$/i)) iconClass = 'fa-file-image';
                else if (item.name.match(/\.js$/i)) iconClass = 'fa-file-code';

                li.innerHTML = `<i class="fas ${iconClass}"></i> ${item.name}`;
                li.dataset.name = item.name;
                li.dataset.type = item.data.type; 
                li.dataset.url = item.data.url; 

                li.addEventListener('click', (e) => {
                    if (selectedFileElement) {
                        selectedFileElement.classList.remove('selected-file');
                    }
                    selectedFileElement = li;
                    li.classList.add('selected-file');
                });
                li.addEventListener('contextmenu', (e) => showFileContextMenu(e, item.name, item.data.type, item.data.url));
                ui.fileTree.appendChild(li);
            });

            ui.btnBackFolder.disabled = currentPath.length === 0;
        }

        function showFileContextMenu(event, name, type, url = null) {
            event.preventDefault(); 
            hideFileContextMenu(); 
            hideObjectHierarchyContextMenu();

            if (name) { 
                selectedFileElement = event.currentTarget;
                selectedFileElement.classList.add('selected-file');
                ui.fileContextMenu.dataset.fileName = name;
                ui.fileContextMenu.dataset.fileType = type;
                ui.fileContextMenu.dataset.fileUrl = url;
            } else { 
                 selectedFileElement = null; 
                 ui.fileContextMenu.dataset.fileName = '';
                 ui.fileContextMenu.dataset.fileType = 'container';
                 ui.fileContextMenu.dataset.fileUrl = '';
            }

            ui.ctxNewFolder.style.display = 'block'; 
            ui.ctxNewWorld.style.display = 'block'; 
            ui.ctxApplyTexture.style.display = (type === 'image' && objetoSelecionadoId && motor.getObjetosNaCena()[objetoSelecionadoId]?.threeObj?.isMesh) ? 'block' : 'none';
            ui.ctxOpenWorld.style.display = (type === 'script' && currentPath.join('/') === 'assets/mundos') ? 'block' : 'none';
            ui.ctxRenameFile.style.display = name ? 'block' : 'none'; 
            ui.ctxDeleteFile.style.display = name ? 'block' : 'none';

            ui.fileContextMenu.style.left = `${event.clientX}px`;
            ui.fileContextMenu.style.top = `${event.clientY}px`;
            ui.fileContextMenu.style.display = 'block';

            document.addEventListener('click', hideFileContextMenu, { once: true });
        }

        function hideFileContextMenu() {
            ui.fileContextMenu.style.display = 'none';
            if (selectedFileElement) {
                selectedFileElement.classList.remove('selected-file');
                selectedFileElement = null;
            }
            renderFileTree(); 
        }

        function handleNewFolder() {
            showInputModal('Nova Pasta', 'Nome da Pasta:', 'Apenas letras, números, hífens e underscores.', '', (folderName) => {
                if (folderName && !folderName.includes('/') && !folderName.includes('\\')) { 
                    const targetFolder = selectedFileElement && selectedFileElement.dataset.type === 'folder' ? 
                                         getFolder(currentPath.concat(selectedFileElement.dataset.name)) : 
                                         getFolder(currentPath);
                    if (targetFolder && !targetFolder[folderName]) {
                        targetFolder[folderName] = {}; 
                        renderFileTree();
                        logConsole('info', `Pasta '${folderName}' criada.`);
                    } else {
                        logConsole('warning', `Pasta '${folderName}' já existe ou nome inválido.`);
                    }
                } else if (folderName) {
                    logConsole('warning', 'Nome da pasta contém caracteres inválidos.');
                }
            });
            hideFileContextMenu();
        }
        
        function handleNewWorld() {
            showInputModal('Novo Mundo', 'Nome do Mundo (ex: fase_2):', 'Será adicionado ".js" automaticamente se não incluído.', '', (worldName) => {
                if (worldName && worldName.trim() !== "") {
                    if (!worldName.endsWith('.js')) {
                        worldName += '.js';
                    }
                    
                    let targetMundosFolder;
                    let targetPathArray;

                    if (selectedFileElement && selectedFileElement.dataset.type === 'folder' && 
                        selectedFileElement.dataset.name === 'mundos' && currentPath.join('/') === 'assets') {
                        targetMundosFolder = getFolder(currentPath.concat('mundos'));
                        targetPathArray = ['assets', 'mundos'];
                    } else if (currentPath.join('/') === 'assets/mundos') { 
                        targetMundosFolder = getFolder(currentPath);
                        targetPathArray = [...currentPath];
                    } else { 
                        if (!fileSystem.assets) fileSystem.assets = {};
                        if (!fileSystem.assets.mundos) fileSystem.assets.mundos = {};
                        targetMundosFolder = fileSystem.assets.mundos;
                        targetPathArray = ['assets', 'mundos'];
                    }


                    if (targetMundosFolder && !targetMundosFolder[worldName]) {
                        const defaultWorldScript = `// Novo Mundo: ${worldName}\n\nmotor.adicionarObjeto('chao_${motor._firebaseEncodeKey(worldName.replace('.js',''))}', 'Chão', 'plano', { material: {color: 'green'} });\n\nconsole.log("Mundo '${worldName}' carregado!");\n`;
                        targetMundosFolder[worldName] = {
                            type: 'script',
                            content: defaultWorldScript,
                            url: `data:application/javascript;base64,${btoa(encodeURIComponent(defaultWorldScript))}`
                        };
                        
                        activeWorldPath = targetPathArray.concat(worldName);
                        loadWorldScriptToEditor(activeWorldPath);
                        recarregarMundoAtivo();
                        renderFileTree();
                        logConsole('info', `Novo mundo '${worldName}' criado em '${targetPathArray.join('/')}' e aberto.`);
                    } else {
                        logConsole('warning', `Mundo '${worldName}' já existe em '${targetPathArray.join('/')}'.`);
                    }
                } else if (worldName !== null) { 
                     logConsole('warning', 'Nome do mundo não pode ser vazio.');
                }
            });
            hideFileContextMenu();
        }


        function handleUploadFile(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const currentFolder = getFolder(currentPath);
            if (!currentFolder) {
                logConsole('error', 'Caminho inválido para upload.');
                return;
            }

            Array.from(files).forEach(file => { 
                if (currentFolder[file.name]) {
                    logConsole('warning', `Arquivo '${file.name}' já existe. Ignorando.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    const fileType = file.type.startsWith('image/') || file.name.endsWith('.hdr') ? 'image' : (file.name.endsWith('.js') ? 'script' : 'other');

                    currentFolder[file.name] = {
                        type: fileType,
                        url: fileContent, 
                        content: fileType === 'script' ? fileContent : null 
                    };
                    renderFileTree();
                    logConsole('info', `Arquivo '${file.name}' (${fileType}) carregado.`);
                };
                if (file.type.startsWith('image/') || file.name.endsWith('.hdr')) {
                    reader.readAsDataURL(file); 
                } else if (file.name.endsWith('.js')) {
                    reader.readAsText(file); 
                } else {
                    logConsole('warning', `Tipo de arquivo '${file.name}' não suportado para upload direto no gerenciador. Pode ser salvo, mas talvez não aplicável.`);
                    currentFolder[file.name] = {
                        type: 'other',
                        url: null, 
                        content: null 
                    };
                    renderFileTree();
                }
            });
            ui.fileUploadInput.value = ''; 
        }

        function handleDeleteFile() {
            if (!selectedFileElement) {
                logConsole('warning', 'Nenhum item selecionado para excluir.');
                return;
            }
            const nameToDelete = selectedFileElement.dataset.name;
            const typeToDelete = selectedFileElement.dataset.type;

            if (typeToDelete === 'script' && currentPath.join('/') === 'assets/mundos') {
                const mundosFolder = getFolder(['assets', 'mundos']);
                if (Object.keys(mundosFolder).length <= 1 && mundosFolder[nameToDelete]) {
                    logConsole('error', 'Não é possível excluir o último mundo.');
                    hideFileContextMenu();
                    return;
                }
                if (activeWorldPath.join('/') === currentPath.join('/') + '/' + nameToDelete) {
                    logConsole('error', 'Não é possível excluir o mundo ativo. Abra outro mundo primeiro.');
                    hideFileContextMenu();
                    return;
                }
            }


            let parentFolder = fileSystem;
            for (let i = 0; i < currentPath.length; i++) {
                parentFolder = parentFolder[currentPath[i]];
            }
            showInputModal(`Excluir ${typeToDelete === 'folder' ? 'Pasta' : 'Arquivo'}`, `Tem certeza que deseja excluir "${nameToDelete}"?`, 'Digite CONFIRMAR para prosseguir.', '', (confirmValue) => {
                if (confirmValue.toUpperCase() === 'CONFIRMAR') {
                    if (parentFolder && parentFolder[nameToDelete]) {
                        if (typeToDelete === 'folder' && Object.keys(parentFolder[nameToDelete]).length > 0) {
                            logConsole('error', `Pasta '${nameToDelete}' não está vazia. Exclua o conteúdo primeiro.`);
                            return;
                        }
                        delete parentFolder[nameToDelete];
                        renderFileTree();
                        logConsole('info', `'${nameToDelete}' excluído.`);
                    } else {
                        logConsole('error', `Erro ao excluir '${nameToDelete}'. Item não encontrado.`);
                    }
                } else {
                    logConsole('info', `Exclusão de '${nameToDelete}' cancelada.`);
                }
            });
            hideFileContextMenu();
        }

        function handleRenameFile() {
            if (!selectedFileElement) {
                logConsole('warning', 'Nenhum item selecionado para renomear.');
                return;
            }
            const oldName = selectedFileElement.dataset.name;
            
            showInputModal(`Renomear "${oldName}"`, 'Novo Nome:', 'Apenas letras, números, hífens e underscores.', oldName, (newName) => {
                if (newName && newName.trim() !== '' && newName !== oldName && !newName.includes('/') && !newName.includes('\\')) {
                    const currentFolder = getFolder(currentPath);
                    if (currentFolder && currentFolder[oldName] && !currentFolder[newName]) {
                        currentFolder[newName] = currentFolder[oldName];
                        delete currentFolder[oldName];
                        
                        if (activeWorldPath.join('/') === currentPath.join('/') + '/' + oldName) {
                            activeWorldPath = currentPath.concat(newName);
                        }
                        renderFileTree();
                        logConsole('info', `'${oldName}' renomeado para '${newName}'.`);
                    } else {
                        logConsole('error', `Erro ao renomear '${oldName}'. Nome já existe ou inválido.`);
                    }
                } else if (newName) { 
                    logConsole('warning', 'Nome inválido para renomear (vazio, igual ao antigo, ou contém caracteres inválidos).');
                }
            });
            hideFileContextMenu();
        }

        function loadWorldScriptToEditor(pathArray) {
            const worldFile = getFolder(pathArray.slice(0, -1))?.[pathArray[pathArray.length - 1]];
            if (worldFile && worldFile.type === 'script' && typeof worldFile.content === 'string') {
                aceEditor.setValue(worldFile.content, -1);
                activeWorldPath = [...pathArray]; 
                logConsole('info', `Mundo '${pathArray.join('/')}' carregado no editor.`);
            } else {
                logConsole('error', `Não foi possível carregar o script do mundo: '${pathArray.join('/')}'.`);
            }
        }


        function applyTextureFromFileManager() {
            if (!objetoSelecionadoId) {
                logConsole('warning', 'Selecione um objeto 3D antes de aplicar uma textura.');
                return;
            }
            if (!selectedFileElement || selectedFileElement.dataset.type !== 'image') {
                logConsole('warning', 'Selecione um arquivo de imagem para aplicar como textura.');
                return;
            }

            const fileUrl = selectedFileElement.dataset.url; 
            const fileName = selectedFileElement.dataset.name;
            motor.atualizarPropriedadeObjeto(objetoSelecionadoId, 'material.map', { url: fileUrl, name: fileName });
            logConsole('info', `Textura '${fileName}' aplicada ao objeto selecionado.`);
            hideFileContextMenu();
        }

        function openWorldFromFileManager() {
            if (!selectedFileElement || selectedFileElement.dataset.type !== 'script') {
                logConsole('warning', 'Selecione um arquivo de mundo (.js) para abrir.');
                return;
            }
            const worldName = selectedFileElement.dataset.name;
            const worldPath = currentPath.concat(worldName); 
            
            loadWorldScriptToEditor(worldPath);
            recarregarMundoAtivo();
            hideFileContextMenu();
        }

        // --- FUNÇÕES DE TROCA DE ABAS NO PAINEL DIREITO ---
        function showPropertiesPanel() {
            ui.rightPanel.style.display = 'flex';
            ui.fileManagerPanel.style.display = 'none';
            ui.btnTabProperties.classList.add('ativo');
            ui.btnTabFiles.classList.remove('ativo');
        }
        function showFilesPanel() {
            ui.rightPanel.style.display = 'none';
            ui.fileManagerPanel.style.display = 'flex';
            ui.btnTabProperties.classList.remove('ativo');
            ui.btnTabFiles.classList.add('ativo');
        }

        // --- Event Listeners Principais e Modais ---
        function setupEventListeners() {
            ui.btnToggleAnimation.onclick = togglePlayStop;
            ui.btnToggleConsole.onclick = () => ui.bottomPanel.classList.toggle('hidden');
            ui.btnAddObject.onclick = () => toggleModal(ui.modalAddObject, true);
            
            ui.btnOpenSettings.onclick = () => {
                loadGraphicSettingsUI();
                toggleModal(ui.modalSettings, true);
            };
            ui.btnToggleScriptEditor.onclick = () => toggleScriptEditor(true);
            ui.btnRecompileWorld.onclick = recarregarMundoAtivo; 
            ui.btnGenerateScript.onclick = gerarESetarScript;
            
            // Event Listeners para Salvar/Carregar Projeto Firebase
            ui.btnSaveFirebase.onclick = salvarProjetoFirebase;
            ui.btnLoadFirebase.onclick = carregarProjetoFirebase;
            
            ui.btnConfirmSaveFirebase.onclick = confirmSaveFirebase;
            ui.btnCancelSaveFirebase.onclick = hideFirebaseModals;
            ui.btnConfirmLoadFirebase.onclick = confirmLoadFirebase;
            ui.btnCancelLoadFirebase.onclick = hideFirebaseModals;

            // Event Listeners para o Modal de Input Genérico
            ui.btnConfirmInputModal.onclick = confirmInputModal;
            ui.btnCancelInputModal.onclick = hideInputModal;

            // Listeners para controles no canvas
            ui.btnModoTranslate.onclick = () => setTransformMode('translate');
            ui.btnModoRotate.onclick = () => setTransformMode('rotate');
            ui.btnModoScale.onclick = () => setTransformMode('scale');
            ui.canvasDeleteButton.onclick = () => {
                if (objetoSelecionadoId) {
                    motor.removerObjeto(objetoSelecionadoId); 
                    // A UI será atualizada pelo evento 'objetoDesselecionado'
                }
            };


            ui.btnCloseScriptEditor.onclick = () => toggleScriptEditor(false);
            document.getElementById('btn-copy-code').onclick = () => { navigator.clipboard.writeText(aceEditor.getValue()); logConsole('info', 'Código copiado.'); };
            document.getElementById('btn-cancelar-modal').onclick = () => toggleModal(ui.modalAddObject, false);
            ui.btnAdicionarModal.onclick = adicionarNovoObjeto;
            
            document.getElementById('settings-fog-enabled').onchange = (e) => { document.getElementById('settings-fog-options').style.display = e.target.checked ? 'block' : 'none'; };
            document.getElementById('btn-cancelar-settings').onclick = () => toggleModal(ui.modalSettings, false);
            ui.btnSaveSettings.onclick = () => {
                motor.configurarNeblina({ enabled: document.getElementById('settings-fog-enabled').checked, color: document.getElementById('settings-fog-color').value, near: parseFloat(document.getElementById('settings-fog-near').value), far: parseFloat(document.getElementById('settings-fog-far').value) });
                motor.configurarGravidade(parseFloat(document.getElementById('settings-gravity-x').value), parseFloat(document.getElementById('settings-gravity-y').value), parseFloat(document.getElementById('settings-gravity-z').value));
                applyGraphicSettings();
                toggleModal(ui.modalSettings, false);
            };
            window.onresize = updateUI;
            window.addEventListener('objetoSelecionado', (e) => selecionarObjeto(e.detail.id));
            window.addEventListener('objetoDesselecionado', () => { 
                objetoSelecionadoId = null; 
                updateHierarchy(); 
                updatePropertiesPanel(null); 
                updateCanvasControlsVisibility(); 
            });
            window.addEventListener('keydown', (e) => { 
                if (isPickingChild && e.key === 'Escape') {
                    isPickingChild = false;
                    prospectiveParentId = null;
                    document.body.style.cursor = 'default';
                    logConsole('info', 'Seleção de filho cancelada.');
                    document.removeEventListener('keydown', handlePickingChildEscape, true);
                    document.removeEventListener('click', handlePickingChildClick, true);
                } else if (!isPlaying && objetoSelecionadoId) { 
                    if (e.key.toLowerCase() === 't') setTransformMode('translate'); 
                    if (e.key.toLowerCase() === 'r') setTransformMode('rotate'); 
                    if (e.key.toLowerCase() === 's') setTransformMode('scale'); 
                } 
            });
        
            // Listeners para os controles do console
            document.querySelectorAll('.btn-filter').forEach(btn => btn.addEventListener('click', (e) => updateConsoleFilter(e.currentTarget.dataset.filter)));
            document.getElementById('btn-copy-console').onclick = copyConsoleOutput;
            document.getElementById('btn-clear-console').onclick = () => ui.consoleOutput.innerHTML = '';
            document.getElementById('btn-fechar-console').onclick = () => ui.bottomPanel.classList.add('hidden');

            // Listeners para as novas opções gráficas
            ui.settingsQualityPreset.addEventListener('change', (e) => {
                const preset = e.target.value;
                const appliedSettings = motor.aplicarPresetQualidade(preset);
                ui.settingsShadowsEnabled.checked = appliedSettings.sombrasHabilitadas;
                ui.settingsShadowsType.value = appliedSettings.tipoSombra;
                ui.settingsShadowMapSize.value = appliedSettings.shadowMapSize;
                ui.settingsToneMappingEnabled.checked = appliedSettings.toneMappingHabilitado;
                ui.settingsToneMappingExposure.value = appliedSettings.exposicaoToneMapping;
                ui.settingsPixelRatio.value = appliedSettings.pixelRatio;
                ui.pixelRatioValue.textContent = appliedSettings.pixelRatio.toFixed(2);

                ui.settingsShadowsOptions.style.display = ui.settingsShadowsEnabled.checked ? 'block' : 'none';
                ui.settingsToneMappingOptions.style.display = ui.settingsToneMappingEnabled.checked ? 'block' : 'none';
            });

            ui.settingsShadowsEnabled.addEventListener('change', (e) => {
                ui.settingsShadowsOptions.style.display = e.target.checked ? 'block' : 'none';
            });
            ui.settingsToneMappingEnabled.addEventListener('change', (e) => {
                ui.settingsToneMappingOptions.style.display = e.target.checked ? 'block' : 'none';
            });
            ui.settingsPixelRatio.addEventListener('input', (e) => {
                ui.pixelRatioValue.textContent = parseFloat(e.target.value).toFixed(2);
            });

            // Listeners para o Gerenciador de Arquivos
            ui.btnUploadFile.onclick = () => ui.fileUploadInput.click(); 
            ui.fileUploadInput.onchange = handleUploadFile;
            ui.btnBackFolder.onclick = () => { if (currentPath.length > 0) { currentPath.pop(); renderFileTree(); } };
            ui.fileTreeContainer.addEventListener('contextmenu', (e) => {
                if (e.target === ui.fileTreeContainer || e.target === ui.fileTree) { 
                    showFileContextMenu(e, null, 'container');
                }
            });


            // Listeners para o Context Menu (Gerenciador de Arquivos)
            ui.ctxNewFolder.onclick = () => { handleNewFolder(); hideFileContextMenu(); };
            ui.ctxNewWorld.onclick = () => { handleNewWorld(); hideFileContextMenu(); };
            ui.ctxApplyTexture.onclick = applyTextureFromFileManager;
            ui.ctxOpenWorld.onclick = openWorldFromFileManager; 
            ui.ctxRenameFile.onclick = () => { handleRenameFile(); hideFileContextMenu(); };
            ui.ctxDeleteFile.onclick = () => { handleDeleteFile(); hideFileContextMenu(); };

            // Listeners para o Context Menu (Hierarquia de Objetos)
            ui.ctxSetParent.onclick = handleSetParent;
            ui.ctxRemoveParent.onclick = handleRemoveParent;

             // Listeners para abas do painel direito
            ui.btnTabProperties.onclick = showPropertiesPanel;
            ui.btnTabFiles.onclick = showFilesPanel;


            // Listeners para configurações de Background
            ui.settingsBackgroundColor.addEventListener('input', (e) => {
                motor.configurarFundoCena({ color: e.target.value });
            });
            ui.btnLoadEnvironmentMap.onclick = () => ui.settingsEnvironmentMapFile.click();
            ui.settingsEnvironmentMapFile.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    ui.settingsEnvironmentMapName.value = file.name;
                    logConsole('info', `Imagem ambiente '${file.name}' selecionada. Clique em Aplicar para carregar.`);
                } else {
                    ui.settingsEnvironmentMapName.value = 'Nenhuma';
                }
            };
            ui.btnClearEnvironmentMap.onclick = () => {
                ui.settingsEnvironmentMapName.value = 'Nenhuma';
                ui.settingsEnvironmentMapFile.value = ''; 
                motor.configurarFundoCena({ environmentMap: null });
                logConsole('info', 'Imagem ambiente removida.');
            };
        }
        
        function toggleModal(modal, show) { modal.classList.toggle('visivel', show); }
        function toggleScriptEditor(show) { ui.codigoEditorContainer.classList.toggle('visivel', show); }
        function setTransformMode(mode) { 
            motor.getControlesTransform().setMode(mode); 
            ['btn-modo-translate', 'btn-modo-rotate', 'btn-modo-scale'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) btn.classList.remove('ativo');
            }); 
            const activeBtn = document.getElementById(`btn-modo-${mode}`);
            if(activeBtn) activeBtn.classList.add('ativo');
        }

        init();
    });
    </script>
</body>
</html>